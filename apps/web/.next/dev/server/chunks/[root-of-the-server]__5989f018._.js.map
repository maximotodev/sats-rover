{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///home/maximoto/dev/sats-rover/apps/web/src/app/api/merchants/route.ts"],"sourcesContent":["// src/app/api/merchants/route.ts\nimport { NextResponse } from \"next/server\";\nimport { Merchant } from \"@/lib/types\";\n\nexport const revalidate = 3600;\n\nconst OVERPASS_INSTANCE = \"https://overpass-api.de/api/interpreter\";\n\nexport async function GET(request: Request) {\n  const { searchParams } = new URL(request.url);\n  const rawBbox = searchParams.get(\"bbox\");\n\n  if (!rawBbox)\n    return NextResponse.json({ error: \"Missing bbox\" }, { status: 400 });\n\n  // SENIOR FIX: Normalize BBox\n  // We round to 3 decimal places (~110m precision).\n  // This drastically increases cache hit rates on the edge.\n  const bbox = rawBbox\n    .split(\",\")\n    .map((coord) => Number(coord).toFixed(3))\n    .join(\",\");\n\n  const query = `\n    [out:json][timeout:25];\n    (\n      node[\"payment:lightning\"=\"yes\"](${bbox});\n      way[\"payment:lightning\"=\"yes\"](${bbox});\n      node[\"currency:XBT\"=\"yes\"](${bbox});\n      way[\"currency:XBT\"=\"yes\"](${bbox});\n    );\n    out center;\n  `;\n\n  try {\n    const controller = new AbortController();\n\n    // UPDATED: Increased hard timeout to 25 seconds\n    const timeoutId = setTimeout(() => controller.abort(), 25000);\n\n    const response = await fetch(OVERPASS_INSTANCE, {\n      method: \"POST\",\n      body: query,\n      signal: controller.signal,\n      headers: {\n        \"Content-Type\": \"application/x-www-form-urlencoded\",\n        \"User-Agent\": \"SatsRover/1.0\",\n      },\n    });\n\n    clearTimeout(timeoutId);\n\n    // If Overpass is down, throw specific error\n    if (!response.ok) {\n      throw new Error(`Overpass API responded with ${response.status}`);\n    }\n\n    const data = await response.json();\n\n    const merchants: Merchant[] = data.elements.map((el: any) => ({\n      id: el.id.toString(),\n      name: el.tags.name || \"Unknown Merchant\",\n      lat: el.lat || el.center.lat,\n      lon: el.lon || el.center.lon,\n      category: el.tags.shop || el.tags.amenity || \"other\",\n      tags: el.tags,\n    }));\n\n    return NextResponse.json({ data: merchants });\n  } catch (error: any) {\n    console.error(\"Merchant Fetch Error:\", error);\n\n    // Return empty data on error so the map doesn't crash, just shows nothing\n    // This is \"Graceful Degradation\"\n    return NextResponse.json(\n      { data: [], error: \"Upstream API slow\", details: error.message },\n      { status: 200 } // Return 200 with empty data to prevent UI errors\n    );\n  }\n}\n"],"names":[],"mappings":";;;;;;AAAA,iCAAiC;AACjC;;AAGO,MAAM,aAAa;AAE1B,MAAM,oBAAoB;AAEnB,eAAe,IAAI,OAAgB;IACxC,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,QAAQ,GAAG;IAC5C,MAAM,UAAU,aAAa,GAAG,CAAC;IAEjC,IAAI,CAAC,SACH,OAAO,iTAAY,CAAC,IAAI,CAAC;QAAE,OAAO;IAAe,GAAG;QAAE,QAAQ;IAAI;IAEpE,6BAA6B;IAC7B,kDAAkD;IAClD,0DAA0D;IAC1D,MAAM,OAAO,QACV,KAAK,CAAC,KACN,GAAG,CAAC,CAAC,QAAU,OAAO,OAAO,OAAO,CAAC,IACrC,IAAI,CAAC;IAER,MAAM,QAAQ,CAAC;;;sCAGqB,EAAE,KAAK;qCACR,EAAE,KAAK;iCACX,EAAE,KAAK;gCACR,EAAE,KAAK;;;EAGrC,CAAC;IAED,IAAI;QACF,MAAM,aAAa,IAAI;QAEvB,gDAAgD;QAChD,MAAM,YAAY,WAAW,IAAM,WAAW,KAAK,IAAI;QAEvD,MAAM,WAAW,MAAM,MAAM,mBAAmB;YAC9C,QAAQ;YACR,MAAM;YACN,QAAQ,WAAW,MAAM;YACzB,SAAS;gBACP,gBAAgB;gBAChB,cAAc;YAChB;QACF;QAEA,aAAa;QAEb,4CAA4C;QAC5C,IAAI,CAAC,SAAS,EAAE,EAAE;YAChB,MAAM,IAAI,MAAM,CAAC,4BAA4B,EAAE,SAAS,MAAM,EAAE;QAClE;QAEA,MAAM,OAAO,MAAM,SAAS,IAAI;QAEhC,MAAM,YAAwB,KAAK,QAAQ,CAAC,GAAG,CAAC,CAAC,KAAY,CAAC;gBAC5D,IAAI,GAAG,EAAE,CAAC,QAAQ;gBAClB,MAAM,GAAG,IAAI,CAAC,IAAI,IAAI;gBACtB,KAAK,GAAG,GAAG,IAAI,GAAG,MAAM,CAAC,GAAG;gBAC5B,KAAK,GAAG,GAAG,IAAI,GAAG,MAAM,CAAC,GAAG;gBAC5B,UAAU,GAAG,IAAI,CAAC,IAAI,IAAI,GAAG,IAAI,CAAC,OAAO,IAAI;gBAC7C,MAAM,GAAG,IAAI;YACf,CAAC;QAED,OAAO,iTAAY,CAAC,IAAI,CAAC;YAAE,MAAM;QAAU;IAC7C,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,yBAAyB;QAEvC,0EAA0E;QAC1E,iCAAiC;QACjC,OAAO,iTAAY,CAAC,IAAI,CACtB;YAAE,MAAM,EAAE;YAAE,OAAO;YAAqB,SAAS,MAAM,OAAO;QAAC,GAC/D;YAAE,QAAQ;QAAI,EAAE,kDAAkD;;IAEtE;AACF"}}]
}